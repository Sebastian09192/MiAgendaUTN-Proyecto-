<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MiAgendaUTN.Views.ListaTareasPage"
             Title="Lista de Tareas">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Nueva" 
                     Command="{Binding CrearTareaCommand}" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*" Padding="10">

        <!-- Indicador de carga -->
        <ActivityIndicator Grid.Row="0"
                          IsRunning="{Binding IsBusy}"
                          IsVisible="{Binding IsBusy}"
                          Color="#2A9D8F"
                          Margin="10" />

        <!-- Lista de tareas -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsBusy}"
                     Command="{Binding CargarTareasCommand}">

            <CollectionView ItemsSource="{Binding Tareas}">
                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center" 
                                       HorizontalOptions="Center"
                                       Padding="20">
                        <Label Text="📝" 
                               FontSize="48" 
                               HorizontalOptions="Center" />
                        <Label Text="No hay tareas" 
                               FontSize="18" 
                               HorizontalOptions="Center"
                               Margin="0,10,0,0" />
                        <Button Text="Crear primera tarea"
                                Command="{Binding CrearTareaCommand}"
                                BackgroundColor="#2A9D8F"
                                TextColor="White"
                                Margin="0,20,0,0" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Editar"
                                              BackgroundColor="#2196F3"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditarTareaCommand}"
                                              CommandParameter="{Binding .}" />
                                    <SwipeItem Text="Eliminar"
                                              BackgroundColor="#F44336"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EliminarTareaCommand}"
                                              CommandParameter="{Binding .}" />
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <Border StrokeShape="RoundRectangle 10"
                                    Background="White"
                                    Stroke="#E0E0E0"
                                    Margin="5"
                                    Padding="15">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditarTareaCommand}"
                                        CommandParameter="{Binding .}" />
                                </Border.GestureRecognizers>

                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">

                                    <!-- Checkbox -->
                                    <CheckBox Grid.Column="0"
                                             IsChecked="{Binding EstaCompletada}"
                                             Color="#2A9D8F">
                                        <CheckBox.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.CambiarEstadoCommand}"
                                                CommandParameter="{Binding .}" />
                                        </CheckBox.GestureRecognizers>
                                    </CheckBox>

                                    <!-- Información de la tarea -->
                                    <VerticalStackLayout Grid.Column="1" Spacing="5">
                                        <Label Text="{Binding Titulo}"
                                              FontSize="16"
                                              FontAttributes="Bold">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label" 
                                                           Binding="{Binding EstaCompletada}" 
                                                           Value="True">
                                                    <Setter Property="TextDecorations" Value="Strikethrough"/>
                                                    <Setter Property="Opacity" Value="0.6"/>
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>

                                        <Label Text="{Binding Categoria}"
                                              FontSize="12"
                                              TextColor="#2A9D8F" />

                                        <Label Text="{Binding FechaVencimiento, StringFormat='Vence: {0:dd/MM/yyyy}'}"
                                              FontSize="12"
                                              TextColor="Gray" />
                                    </VerticalStackLayout>

                                    <!-- Indicador de prioridad -->
                                    <BoxView Grid.Column="2"
                                            WidthRequest="4"
                                            HeightRequest="50"
                                            CornerRadius="2">
                                        <BoxView.Triggers>
                                            <DataTrigger TargetType="BoxView" 
                                                       Binding="{Binding Prioridad}" 
                                                       Value="Alta">
                                                <Setter Property="Color" Value="#F44336"/>
                                            </DataTrigger>
                                            <DataTrigger TargetType="BoxView" 
                                                       Binding="{Binding Prioridad}" 
                                                       Value="Media">
                                                <Setter Property="Color" Value="#FF9800"/>
                                            </DataTrigger>
                                            <DataTrigger TargetType="BoxView" 
                                                       Binding="{Binding Prioridad}" 
                                                       Value="Baja">
                                                <Setter Property="Color" Value="#4CAF50"/>
                                            </DataTrigger>
                                        </BoxView.Triggers>
                                    </BoxView>
                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
    </Grid>
</ContentPage>